---
bg: 'mongodb.jpg'
layout: post
title:  "mongodb分片"
crawlertitle: "mongodb"
summary: ""
date:   2019-09-03 09:00:00 +0700
categories: posts
tags: 'mongodb'
author: 宋天
---


mongodb分片概念及组成



#### 概念
mongodb横向扩展，将数据存储到不同的地方。


#### 组件

###### mongos, 配置服务器，数据分片


- 每个分片存储一部分数据，可以部署复制集
- mongos路由可以将客户请求发生至相关的分片
- 配置服务器保持集群配置和元数据，可以部署为复制集


###### 主分片

- 集群中的每个**数据库**会选择一个分片作为主分片
- 主分片存储所有不需要分片的集合
- 创建数据库时，数据最少的分片被选为主分片

###### 分片片键

- 片键值被用来将集合中的文档划分为数据段
- 片键必须对应一个索引或索引前缀（单键或复合键）
- 可以使用片键值的哈希值来生成哈希片键


- 片键值的范围更广（可使用复合片键扩大范围）
- 片键值的分布更平衡（可使用复合片键平衡分布）
- 片键值不要单向增大/减小（可使用哈希片键）
- 片键是无法修改的

###### 配置服务器

- 存储各分片数据段列表和数据段范围
- 存储你集群的认证和授权配置
- 不同的集群不要共用配置服务器

###### mongos

- 客户请求应发给mongos,而不是分片服务器
- 当查询包含分片片键时，mongos将查询发送到指定分片
- 否则，mongos将查询发送到所有分片，并汇总所有查询结果

#### 动态平衡


###### 数据段分裂
- 当数据段尺寸过大或包含过多文档时触发数据段分裂
- 只有新增/更新文档时才可能自动触发数据段分裂
- 数据段分裂通过更新元数据来实现，成本比较低

###### 集群的平衡

- 后台运行的平衡器负责监视和调整集群的平衡
- 当最大和最小分片之间的数据段数量相差过大时触发
- 集群中添加或移除分片时也会触发