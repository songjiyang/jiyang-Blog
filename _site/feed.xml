<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>JiYang's Blog</title>
    <description>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</description>
    <link>http://localhost:4000/</link>
    <atom:link href="http://localhost:4000/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Thu, 05 Sep 2019 11:46:39 +0800</pubDate>
    <lastBuildDate>Thu, 05 Sep 2019 11:46:39 +0800</lastBuildDate>
    <generator>Jekyll v3.8.5</generator>
    
      <item>
        <title>mongodb工具，安全，故障</title>
        <description>&lt;p&gt;mongodb导入和导入工具，监控工具，授权认证，故障排除&lt;/p&gt;

&lt;h3 id=&quot;安全&quot;&gt;安全&lt;/h3&gt;

&lt;h4 id=&quot;用户&quot;&gt;用户&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;创建第一个用户&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;gt; db.createUser(
... {
... user: &quot;myUserAdmin&quot;,
... pwd: &quot;passwd&quot;,
... roles: [ &quot;userAdminAnyDatabase&quot;]
... }
... )
Successfully added user: { &quot;user&quot; : &quot;myUserAdmin&quot;, &quot;roles&quot; : [ &quot;userAdminAnyDatabase&quot; ] }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;认证&quot;&gt;认证&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;在mongod启动时加入–auth参数开启登录验证&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;使用用户名和密码进行身份验证&lt;/p&gt;

    &lt;p&gt;mongo -u “myUserAdmin” -p “passwd” –authenticationDatabase “admin”&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;authenticationDatabase表示创建用户使用的数据库，但不是指定该用户权限的。&lt;/li&gt;
  &lt;li&gt;如果目的既是登陆test数据库，而用户也是test数据库中创建，那么可以不用写后面的参数 –authenticationDatabase&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;授权&quot;&gt;授权&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;权限 = 在哪里 + 做什么&lt;/p&gt;

    &lt;p&gt;{resource:{db:”test”, collections: “”}, actions:[“find”, “update”]}&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;角色，一组权限的集合
    &lt;ol&gt;
      &lt;li&gt;read, 读取当前数据库中所有非系统集合&lt;/li&gt;
      &lt;li&gt;readWrite, 读写当前数据库中所有非系统集合&lt;/li&gt;
      &lt;li&gt;dbAdmin, 管理当前数据库&lt;/li&gt;
      &lt;li&gt;userAdmin, 管理当前数据库中的用户和角色&lt;/li&gt;
      &lt;li&gt;read/readWrite/dbAdmin/userAdminAnyDatabase 对所有数据库执行操作（只在admin数据库提供）&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;创建一个只能读取test数据库的用户&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;use test;
db.createUser(
    {
        user: &quot;testReader&quot;,
        pwd: &quot;passwd&quot;,
        roles: [{role: &quot;read&quot;, db: &quot;test&quot;}]
    }
)

Successfully added user: {
	&quot;user&quot; : &quot;testReader&quot;,
	&quot;roles&quot; : [
		{
			&quot;role&quot; : &quot;read&quot;,
			&quot;db&quot; : &quot;test&quot;
		}
	]
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;创建一个只能读取accounts集合的用户&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;use test;
db.createRole(
    {
        role: &quot;readAccount&quot;,
        privileges: [
            {
                resource: {
                    db:&quot;test&quot;, 
                    collection: &quot;accounts&quot;
                },
                actions: [&quot;find&quot;]
            }
        ],
        roles: []
    }
)
use test;
db.createUser(
    {
        user: &quot;accountsReader&quot;,
        pwd: &quot;passwd&quot;,
        roles: [&quot;readAccount&quot;]
    }
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;roles字段可以从已有角色中继承权限&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;工具&quot;&gt;工具&lt;/h2&gt;

&lt;h4 id=&quot;数据导入导出&quot;&gt;数据导入导出&lt;/h4&gt;
&lt;h5 id=&quot;mongoexport&quot;&gt;&lt;a href=&quot;https://docs.mongodb.com/manual/reference/program/mongoexport/&quot;&gt;mongoexport&lt;/a&gt;&lt;/h5&gt;
&lt;h5 id=&quot;mongoimport&quot;&gt;&lt;a href=&quot;https://docs.mongodb.com/manual/reference/program/mongoimport/index.html&quot;&gt;mongoimport&lt;/a&gt;&lt;/h5&gt;
&lt;ul&gt;
  &lt;li&gt;upsertFileds 根据特定字段去对比从而选择去更新还是插入&lt;/li&gt;
  &lt;li&gt;stopOnError 发送错误停止&lt;/li&gt;
  &lt;li&gt;maintainInsertionOrder 维持csv的顺序导入&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;监控&quot;&gt;监控&lt;/h4&gt;

&lt;h5 id=&quot;mongostat统计mongodb数据库当前的状态&quot;&gt;&lt;a href=&quot;https://docs.mongodb.com/manual/reference/program/mongostat/index.html&quot;&gt;mongostat&lt;/a&gt;，统计mongodb数据库当前的状态&lt;/h5&gt;

&lt;ul&gt;
  &lt;li&gt;需要用户有clusterMonitor的角色&lt;/li&gt;
  &lt;li&gt;可以指定打印间隔和次数&lt;/li&gt;
  &lt;li&gt;o指定需要查看的指标
    &lt;ol&gt;
      &lt;li&gt;commman - 每秒执行的命令数&lt;/li&gt;
      &lt;li&gt;dirty, used - 数据库引擎缓存的使用量百分比&lt;/li&gt;
      &lt;li&gt;vsize - 虚拟内存使用量（MB)&lt;/li&gt;
      &lt;li&gt;res - 常驻内存使用量&lt;/li&gt;
      &lt;li&gt;conn - 连接数&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h5 id=&quot;mongotop显示每个集合上的读写时间&quot;&gt;&lt;a href=&quot;https://docs.mongodb.com/manual/reference/program/mongotop/index.html&quot;&gt;mongotop&lt;/a&gt;,显示每个集合上的读写时间&lt;/h5&gt;

&lt;h2 id=&quot;故障&quot;&gt;故障&lt;/h2&gt;

&lt;h5 id=&quot;响应时间过长&quot;&gt;响应时间过长&lt;/h5&gt;

&lt;ul&gt;
  &lt;li&gt;合适的索引，使用explain()查看索引的有效性&lt;/li&gt;
  &lt;li&gt;工作集超出RAM的大小，使用mongostat查看服务的状态，used百分比远远大过dirty的百分比时，表示mongo内存不够使用&lt;/li&gt;
&lt;/ul&gt;

&lt;h5 id=&quot;连接失败&quot;&gt;连接失败&lt;/h5&gt;

&lt;ul&gt;
  &lt;li&gt;默认情况下，mongod进程可以支持多达65536个连接，不恰当的&lt;strong&gt;配置&lt;/strong&gt;可能限制连接数
    &lt;ol&gt;
      &lt;li&gt;db.serverStatus().connections可查看连接数&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;ulimt -a配置中间的open files也会限制mongodb的连接数&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Thu, 05 Sep 2019 10:00:00 +0800</pubDate>
        <link>http://localhost:4000/posts/mongodb_tool_security/</link>
        <guid isPermaLink="true">http://localhost:4000/posts/mongodb_tool_security/</guid>
        
        <category>mongodb</category>
        
        
        <category>posts</category>
        
      </item>
    
      <item>
        <title>mongodb技巧</title>
        <description>&lt;p&gt;mongodb的一些技巧&lt;/p&gt;

&lt;h2 id=&quot;按日期分组&quot;&gt;按日期分组&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;要分组的日期是Date类型的&lt;/li&gt;
  &lt;li&gt;注意timezone, +0800代表中国时区&lt;/li&gt;
  &lt;li&gt;group的_id可以进行转字符串，然后连接处理&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;db.suggestions.aggregate([
    {
        $project: {
          year: {$year: {date:'$submitDate', timezone:'+0800'}},
          month: {$month: {date:'$submitDate', timezone:'+0800'}},
          dayOfMonth: {$dayOfMonth: {date:'$submitDate', timezone:'+0800'}},
          submitDate:1
        }
    },
    {
        $group: {
            _id:{year:'$year', month:'$month', day:'$dayOfMonth'},
            
            count: {
                $sum: 1
            }
        }
    },
    {   
        $sort : { _id : 1 }
    }   
])
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;要分组的日期是timeStamp，并且为string, 网上查找的方法&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;db.getCollection('wechat_message').aggregate(  
    [     
        {   $project : { day : {$substr: [&quot;$sendTime&quot;, 0, 10] }}},          
        {   $group   : { _id : &quot;$day&quot;,  number : { $sum : 1 }}},  
        {   $sort    : { _id : -1 }}          
    ]  
)  

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
</description>
        <pubDate>Thu, 05 Sep 2019 10:00:00 +0800</pubDate>
        <link>http://localhost:4000/posts/mongodb_skill/</link>
        <guid isPermaLink="true">http://localhost:4000/posts/mongodb_skill/</guid>
        
        <category>mongodb</category>
        
        
        <category>posts</category>
        
      </item>
    
      <item>
        <title>kubernetes基础使用</title>
        <description>&lt;p&gt;kubernetes基础使用，创建一个Deployment,创建一个Service&lt;/p&gt;

&lt;h3 id=&quot;使用k8s部署一个nginx&quot;&gt;使用k8s部署一个nginx&lt;/h3&gt;

&lt;h4 id=&quot;创建一个deployment&quot;&gt;创建一个Deployment&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;controllers/nginx-deployment.yaml&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;apps/v1&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Deployment&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx-deployment&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;3&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;matchLabels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;containerPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;80&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;必需字段&quot;&gt;必需字段&lt;/h5&gt;
&lt;p&gt;在想要创建的 Kubernetes 对象对应的 .yaml 文件中，需要配置如下的字段：&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;apiVersion - 创建该对象所使用的 Kubernetes API 的版本&lt;/li&gt;
  &lt;li&gt;kind - 想要创建的对象的类型&lt;/li&gt;
  &lt;li&gt;metadata - 帮助识别对象唯一性的数据，包括一个 name 字符串、UID 和可选的 namespace&lt;/li&gt;
  &lt;li&gt;spec 字段。对象 spec 的精确格式对每个 Kubernetes 对象来说是不同的，包含了特定于该对象的嵌套字段。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.15/#&quot;&gt;Kubernetes API&lt;/a&gt;参考能够帮助我们找到任何我们想创建的对象的 spec 格式。&lt;/p&gt;

&lt;h4 id=&quot;问题&quot;&gt;问题&lt;/h4&gt;

&lt;ol&gt;
  &lt;li&gt;Deployment的matchLabels必选能选到template的label,否则创建资源的时候会报错。==为什么==, 因为这个Deployment选择不到对应的pod，达不到要求的replica为3，所以会不停新建template的Pod。&lt;/li&gt;
  &lt;li&gt;现在如何访问这个nginx
    &lt;ul&gt;
      &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;kubectl port-forward &amp;lt;podname&amp;gt; 80:80&lt;/code&gt;，使用kubectl代理，这样只有拥有k8s集群权限才行，用不了k8s也访问不到&lt;/li&gt;
      &lt;li&gt;建一个Service，下面介绍&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&quot;创建一个service&quot;&gt;创建一个Service&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;service/nginx-service.yml&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Service&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx-service&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;http&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;protocol&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;TCP&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;80&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;targetPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;80&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;nodePort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;31100&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;NodePort&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;spec.type分别有ClusterIP(default), NodePort, and LoadBalancer，
    &lt;ol&gt;
      &lt;li&gt;默认的ClusterIP会给这个Service生成一个虚拟IP,在k8s集群中，我们可以通过这个ip,或者Service的name(借助的k8s的dns解析)来访问这个服务，但我们还是无法在外部访问到这个服务&lt;/li&gt;
      &lt;li&gt;NodePort会在k8s集群中的所有Node开启一个nodePort指定的端口或者随机端口，然后我们可以拿k8s集群中任意一个机器的IP加这个nodePort就可以访问这个服务，但这个任然不是最佳的方式，因为我们需要一个额外的文件来维护不同服务的不同端口，在后面可以借助ingress，和ingress controller边缘路由器来暴露端口，并对k8s内部的服务进行反向代理。&lt;/li&gt;
      &lt;li&gt;LoadBalancer借助云服务商提供的LoadBalancer软件，将服务暴露在云服务商的LB软件上，每个厂商的配置不太相同&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Tue, 03 Sep 2019 17:53:00 +0800</pubDate>
        <link>http://localhost:4000/posts/k8s_basic_use/</link>
        <guid isPermaLink="true">http://localhost:4000/posts/k8s_basic_use/</guid>
        
        <category>kubernetes</category>
        
        
        <category>posts</category>
        
      </item>
    
      <item>
        <title>kubernetes基础概念和命令</title>
        <description>&lt;p&gt;kubernetes基础，包括kubectl命令和kubenetes的组件的概念，Pod, Node, Service等。&lt;/p&gt;

&lt;h4 id=&quot;概念&quot;&gt;概念&lt;/h4&gt;

&lt;p&gt;    Kubernetes最初源于谷歌内部的Borg，提供了面向应用的容器集群部署和管理系统。Kubernetes的目标旨在消除编排物理/虚拟计算，网络和存储基础设施的负担，并使应用程序运营商和开发人员完全将重点放在以容器为中心的原语上进行自助运营。Kubernetes 也提供稳定、兼容的基础（平台），用于构建定制化的workflows 和更高级的自动化任务。 Kubernetes 具备完善的集群管理能力，包括多层次的安全防护和准入机制、多租户应用支撑能力、透明的服务注册和服务发现机制、内建负载均衡器、故障发现和自我修复能力、服务滚动升级和在线扩容、可扩展的资源自动调度机制、多粒度的资源配额管理能力。 Kubernetes 还提供完善的管理工具，涵盖开发、部署测试、运维监控等各个环节。&lt;/p&gt;

&lt;h4 id=&quot;kubenetes组成&quot;&gt;kubenetes组成&lt;/h4&gt;

&lt;p&gt;&lt;img src=&quot;http://pvuj0n458.bkt.clouddn.com/youdao/kubernetes-high-level-component-archtecture.jpg&quot; alt=&quot;kubernetes-high-level-component-architectur&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Master 控制节点
    &lt;ol&gt;
      &lt;li&gt;Kubernetes API Server，提供Rest接口，所有资源增删改查的唯一入口&lt;/li&gt;
      &lt;li&gt;Kubernetes Controller Manager，资源对象的自动化控制中心&lt;/li&gt;
      &lt;li&gt;Kubernetes Scheduler，负责资源调度(Pod调度)&lt;/li&gt;
      &lt;li&gt;etcd，资源数据的保存&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;Node 工作节点
    &lt;ol&gt;
      &lt;li&gt;kubelet，负责容器创建、启停，与Master沟通&lt;/li&gt;
      &lt;li&gt;kube-proxy, 实现Kubernetes Service的通信和负载均衡&lt;/li&gt;
      &lt;li&gt;Docker Engine, 负责容器创建和管理&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;Pod 基本单位
    &lt;ol&gt;
      &lt;li&gt;Pause容器，代表整个Pod的状态，共享IP，Volume&lt;/li&gt;
      &lt;li&gt;用户的N个业务容器&lt;/li&gt;
      &lt;li&gt;Endpoint = Pod IP + contrainerPort，代表服务进行的对外通信地址&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;Label 标签
    &lt;ol&gt;
      &lt;li&gt;用户自定义的key-value键值对，可以附加到Node, Pod, Service, RC等资源对象上面&lt;/li&gt;
      &lt;li&gt;LabelSelector可以通过=, in, not in等匹配条件来获取到特定的资源&lt;/li&gt;
      &lt;li&gt;kube-controller进程通过资源对象RC定义的Label Selector来筛选要监控的Pod副本数量&lt;/li&gt;
      &lt;li&gt;kube-proxy进行通过Service的Label Selector来选择对应的Pod，自定建议起每个Service到Pod的请求转发路由表&lt;/li&gt;
      &lt;li&gt;Node定义特定Lable，Pod的NodeSelector，kube-scheduler实现定向调度&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;Deployment 部署
    &lt;ol&gt;
      &lt;li&gt;RC的一次升级，和RC相似度超过90%&lt;/li&gt;
      &lt;li&gt;相对于RC最大的升级是可以随时知道Pod部署的进度&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;Horizontal Pod Autoscaler(HPA) 横向自动扩容
    &lt;ol&gt;
      &lt;li&gt;Pod横向自动扩容，通过追踪Pod的负载情况来确定是否针对调整目标Pod的副本数&lt;/li&gt;
      &lt;li&gt;通过CPUUtilizationPercetage或者应用自定义度量指标来确定是否需要扩容或者缩容&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;StatefulSet 有状态集群
    &lt;ol&gt;
      &lt;li&gt;类似Deployment,但用于有状态的集群，例如MySQL集群，MongoDB集群，Akka集群等&lt;/li&gt;
      &lt;li&gt;建立的Pod有稳定，唯一的网络标识&lt;/li&gt;
      &lt;li&gt;启停顺序是受控的&lt;/li&gt;
      &lt;li&gt;使用PV或者PVC来做数据的持久化，PV为PersistentVolum, PVC为PersistentVolumeClaim&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;Service 服务
    &lt;ol&gt;
      &lt;li&gt;微服务，Pod和RC都是为了支持服务&lt;/li&gt;
      &lt;li&gt;NodeIp(每个节点物理网卡的IP地址), PodIp(虚拟的二层网络), ClusterIp(虚拟的IP,无法被ping,只能和Service Port组成一个具体的通信端口)&lt;/li&gt;
      &lt;li&gt;PodIp和ClusterIp是无法在k8s集群外访问的，要想访问，就得使用NodePort类型的Service,&lt;/li&gt;
      &lt;li&gt;NodePort在k8s的集群的每个Node建立一个访问端口，我们只要访问任意一台Node就可以访问，但还需要一个负载均衡，可以将NodePort类型改为LoadBalancer，利用公有云提供的服务来实现负载均衡。&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;Job 任务
    &lt;ol&gt;
      &lt;li&gt;批处理任务通常并行或者串行启动多个计算进程去处理一批工作项, 与RC, Deployment, RS类似，不过是一个特殊的Pod控制器&lt;/li&gt;
      &lt;li&gt;Job控制的Pod是短暂运行的&lt;/li&gt;
      &lt;li&gt;k8s的1.5版本后提供了CronJob&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;Volume 存储卷
    &lt;ol&gt;
      &lt;li&gt;Volume是Pod中能被多个容器访问的共享目录，和Docker的Volume类似，但不能等价。&lt;/li&gt;
      &lt;li&gt;和Pod生命周期相同，和容器生命周期无关&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;Persistent Volume 网络存储
    &lt;ol&gt;
      &lt;li&gt;每个Node都可以访问，独立于Pod之外，类似网盘&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;Namespace 命名空间
    &lt;ol&gt;
      &lt;li&gt;实现多租户的资源隔离&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;Annoation 注解
    &lt;ol&gt;
      &lt;li&gt;和Label类似，Label具有严格的命名规则，Annoation是用户定义的任意附加信息， 以便于外部工具查找&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;ConfigMap
    &lt;ol&gt;
      &lt;li&gt;集中化的配置，解决了Docker容器只能使用环境变量或者共享文件的形式将一些配置传入容器内&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;kubectl-基本命令&quot;&gt;kubectl 基本命令&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;kubectl [command] [TYPE] [NAME] [flags]&lt;/li&gt;
&lt;/ul&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;命令&lt;/th&gt;
      &lt;th&gt;作用&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;kubectl create -f mysql-&amp;lt;xx&amp;gt;.yaml&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;根据yaml文件创建一个RC(ReplicationController), 或者Service, 取决于yaml文件中的kind属性&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;kubectl get &amp;lt;resource&amp;gt;&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;查看资源的大概情况,&lt;code class=&quot;highlighter-rouge&quot;&gt;-o yaml&lt;/code&gt;可以输出一个yaml格式。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;kubectl describe &amp;lt;resource&amp;gt;&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;描述资源的详细信息&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;kubectl delete &amp;lt;rc或svc&amp;gt;&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;删除一个RC或者Service&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;kubectl scale rc my-web --replicas=3&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;动态调整RC副本数量&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;kubectl logs &amp;lt;podname&amp;gt;&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;查看某个pod的日志&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;ul&gt;
  &lt;li&gt;resource可以为pods, rc, nodes, svc, deployments, endpoints(切点), rs(新版本中的RC，支持集合Label selector)等，一般单复数形式都可以&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;-n&lt;/code&gt;命名空间，不写时为默认命名空间，系统命名空间为kube-system，使用可以查看一些系统的资源&lt;/li&gt;
  &lt;li&gt;更多参数参考官方文档&lt;a href=&quot;https://kubernetes.io/docs/reference/kubectl/overview/&quot;&gt;kubectl&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;参考&quot;&gt;参考&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://jimmysong.io/kubernetes-handbook/concepts/&quot;&gt;《kubernetes-handbook》&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Tue, 03 Sep 2019 17:53:00 +0800</pubDate>
        <link>http://localhost:4000/posts/k8s_basic/</link>
        <guid isPermaLink="true">http://localhost:4000/posts/k8s_basic/</guid>
        
        <category>kubernetes</category>
        
        
        <category>posts</category>
        
      </item>
    
      <item>
        <title>mongodb分片</title>
        <description>&lt;p&gt;mongodb分片概念及组成&lt;/p&gt;

&lt;h4 id=&quot;概念&quot;&gt;概念&lt;/h4&gt;
&lt;p&gt;mongodb横向扩展，将数据存储到不同的地方。&lt;/p&gt;

&lt;h4 id=&quot;组件&quot;&gt;组件&lt;/h4&gt;

&lt;h6 id=&quot;mongos-配置服务器数据分片&quot;&gt;mongos, 配置服务器，数据分片&lt;/h6&gt;

&lt;ul&gt;
  &lt;li&gt;每个分片存储一部分数据，可以部署复制集&lt;/li&gt;
  &lt;li&gt;mongos路由可以将客户请求发生至相关的分片&lt;/li&gt;
  &lt;li&gt;配置服务器保持集群配置和元数据，可以部署为复制集&lt;/li&gt;
&lt;/ul&gt;

&lt;h6 id=&quot;主分片&quot;&gt;主分片&lt;/h6&gt;

&lt;ul&gt;
  &lt;li&gt;集群中的每个&lt;strong&gt;数据库&lt;/strong&gt;会选择一个分片作为主分片&lt;/li&gt;
  &lt;li&gt;主分片存储所有不需要分片的集合&lt;/li&gt;
  &lt;li&gt;创建数据库时，数据最少的分片被选为主分片&lt;/li&gt;
&lt;/ul&gt;

&lt;h6 id=&quot;分片片键&quot;&gt;分片片键&lt;/h6&gt;

&lt;ul&gt;
  &lt;li&gt;片键值被用来将集合中的文档划分为数据段&lt;/li&gt;
  &lt;li&gt;片键必须对应一个索引或索引前缀（单键或复合键）&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;可以使用片键值的哈希值来生成哈希片键&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;片键值的范围更广（可使用复合片键扩大范围）&lt;/li&gt;
  &lt;li&gt;片键值的分布更平衡（可使用复合片键平衡分布）&lt;/li&gt;
  &lt;li&gt;片键值不要单向增大/减小（可使用哈希片键）&lt;/li&gt;
  &lt;li&gt;片键是无法修改的&lt;/li&gt;
&lt;/ul&gt;

&lt;h6 id=&quot;配置服务器&quot;&gt;配置服务器&lt;/h6&gt;

&lt;ul&gt;
  &lt;li&gt;存储各分片数据段列表和数据段范围&lt;/li&gt;
  &lt;li&gt;存储你集群的认证和授权配置&lt;/li&gt;
  &lt;li&gt;不同的集群不要共用配置服务器&lt;/li&gt;
&lt;/ul&gt;

&lt;h6 id=&quot;mongos&quot;&gt;mongos&lt;/h6&gt;

&lt;ul&gt;
  &lt;li&gt;客户请求应发给mongos,而不是分片服务器&lt;/li&gt;
  &lt;li&gt;当查询包含分片片键时，mongos将查询发送到指定分片&lt;/li&gt;
  &lt;li&gt;否则，mongos将查询发送到所有分片，并汇总所有查询结果&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;动态平衡&quot;&gt;动态平衡&lt;/h4&gt;

&lt;h6 id=&quot;数据段分裂&quot;&gt;数据段分裂&lt;/h6&gt;
&lt;ul&gt;
  &lt;li&gt;当数据段尺寸过大或包含过多文档时触发数据段分裂&lt;/li&gt;
  &lt;li&gt;只有新增/更新文档时才可能自动触发数据段分裂&lt;/li&gt;
  &lt;li&gt;数据段分裂通过更新元数据来实现，成本比较低&lt;/li&gt;
&lt;/ul&gt;

&lt;h6 id=&quot;集群的平衡&quot;&gt;集群的平衡&lt;/h6&gt;

&lt;ul&gt;
  &lt;li&gt;后台运行的平衡器负责监视和调整集群的平衡&lt;/li&gt;
  &lt;li&gt;当最大和最小分片之间的数据段数量相差过大时触发&lt;/li&gt;
  &lt;li&gt;集群中添加或移除分片时也会触发&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Tue, 03 Sep 2019 10:00:00 +0800</pubDate>
        <link>http://localhost:4000/posts/mongodb_sharding/</link>
        <guid isPermaLink="true">http://localhost:4000/posts/mongodb_sharding/</guid>
        
        <category>mongodb</category>
        
        
        <category>posts</category>
        
      </item>
    
  </channel>
</rss>
